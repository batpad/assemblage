CFab={	_m_cm_scale: 0 ,	_m_global_object_count: 0,		_scale_single_pixel_in_cm: 0,		resizeImageToLoad: function(imgO, cb) // Resize the image to the maximum size	{		var cimg = new Image();		cimg.src = imgO.imgURL;				cimg.onload = function() {					var canv = document.createElement('canvas');						var _width = imgO.width_cm * CHelp.cmToPxFactor ;			var _height = imgO.height_cm * CHelp.cmToPxFactor ;						canv.width = _width; 				canv.height = _height;									var context = canv.getContext('2d');						context.drawImage( cimg, 0 , 0, _width, _height );						var nimg = new Image();					nimg.src = canv.toDataURL();						cb(true, nimg);					};				cimg.onerror = function() { cb(false); } ;	},		dropImageOnCanvas : function( imgObj , c , scale , event , isDblClicked ) // { imgURL , cmWidth , cmHeight }	{		CHelp._m_under_process = true ;  // under process					CFab.resizeImageToLoad(imgObj, function(bok, nimg) {			if(bok)			{				fabric.Image.fromObject( nimg, function(_nimg) {						//$('#canvasView')[0].scrollWidth /2 $('#canvasView')[0].scrollHeight /2					console.log('scrollwidh/2 '+$('#canvasView')[0].scrollWidth /2 +' , scrollheight/2 '+$('#canvasView')[0].scrollHeight /2);															//Drop the object in the approximate center if its been added using the Double Click					var x = ( isDblClicked == false ) ? ( event.pageX - ($('#c').offset().left) ) : ( $('#canvasView')[0].scrollWidth /2 ) ;					var y = ( isDblClicked == false ) ? ( event.pageY - ($('#c').offset().top) ) : ( $('#canvasView')[0].scrollHeight /2 ) ;										var oImg = _nimg.set( { 						idx: (++CFab._m_global_object_count),						left: x, top: y, angle: 0,						object_id : imgObj.object_id,						lockScalingX:true , lockScalingY:true , 						hasRotatingPoint:true ,						hasControls: true , 						hasEndPoints: false ,												selectable : ( (CPan._isActive)?(false):(true) ) // Disable selection when in the PAN mode					} ).scale(scale) ; 										c.add(oImg).renderAll(); 										CFab.setObjectPadding(oImg); // Set padding for very small objects HACK : may have to remove this					CState.saveState(c);					CFab.setScaleIndicator( scale ); 										CHelp._m_app_unsaved = true ; // Current APP is unsaved					CHtml.unBlockScreen();				} );					}			else				alert('Unable to load this image - please try again later.');						} );//					},		scaleCanvas : function()	{			var canvas = CHelp._m_canvas,			cscale = CHelp._m_current_scale,			objects = canvas.getObjects(),			canvas_old_dim = { w: canvas.getWidth(), h: canvas.getHeight() },			scrollx = CPan.getScrollCurMax();			// Position canvas in mid of view 		///////// /////// /////// /////// /////// /////// /////// /////// 		{			canvas.setWidth(CHelp._m_canvas_original_width * cscale);			canvas.setHeight(CHelp._m_canvas_original_height * cscale);						// HACK: BUG ON SOME BROWSERS WHICH MEAN EVEN THO WIDTH/ HEIGHT IS CONTAINED SCROLL BARS ARE DISPLAYED.			// THIS bug can be confirmed by switching in firefox overflow from hidden to auto which recrifies the DOM (even though if they were genuine scroll bars, then the scroll bars should come backl)!						//if($.browser.mozilla) // CUi._isFF is not working			{					$('#canvasView').css('overflow', ( ( cscale == 0.1 ) ? ( 'auto') : ('auto') ) );			}		}		/////// /////// /////// /////// /////// /////// /////// 						for (var i in objects)		{			var idx = objects[i].idx;			var scaleX = objects[i].scaleX;			var scaleY = objects[i].scaleY;			var old_width = objects[i].getWidth();			var old_height = objects[i].getHeight();			var oleft = objects[i].left;			var otop = objects[i].top;						objects[i].scaleX = cscale;			objects[i].scaleY = cscale;									var new_width = objects[i].getWidth();			var new_height = objects[i].getHeight();						var sfwh = (new_width / old_width);			var nleft = (oleft * sfwh);			var ntop = (otop * sfwh);						objects[i].left = nleft;			objects[i].top = ntop;			CFab.setObjectPadding(objects[i]);  // SET  MORE PADDING IF THE IMAGE OBJECT APPEARS VERY SMALL , SO THAT IT CAN BE MOVED BY MOUSE SELECTION					objects[i].setCoords();		}						if( ( canvas_old_dim.w != canvas.getWidth() ) || ( canvas_old_dim.h != canvas.getHeight() ) )		{			CPan.adjustCenterIncrease( scrollx );		}				canvas.renderAll();			},		setObjectPadding : function( obj )	{		obj.padding = (obj.getWidth() < 19 ||obj.getHeight() < 10)	? (2) : (0) ;	},			adjustScale : function(scale)	{				if(!scale)			scale = CHelp._m_current_scale;					CFab.scaleCanvas();		CFab.setScaleIndicator( scale ) ;	},		createToDataURL : function ( c , scale , itemTitle ) //Used for join & export operation	{		var currGroup = c.getActiveGroup() || c.getActiveObject(); //				if( (currGroup.type == "group" || currGroup.isJoinedObj == true) )		{				if( currGroup.isJoinedObj == true && typeof(itemTitle) === "undefined" ){  return;	}						var ddata = new Array();			var groupx = currGroup.left ;			var groupy = currGroup.top ;			var item_ids = [];						if(currGroup.type == "group") 			{				currGroup.forEachObject( function(o,i) 				{						var angleModified = false ;					var angle = 0;					if(o.getAngle() != 0) // Super hack					{						angle = o.getAngle() * 0.0174532925; //convert in the radians												c.renderAll();						angleModified = true;					}										var objectCanvasLeftX = parseFloat( ( o.oCoords.tl.x + ( ( currGroup.width)/2) ) / scale ) ;					var objectCanvasTopY = parseFloat( ( o.oCoords.tl.y + ( ( currGroup.height)/2 ) )/ scale  ) ;										var myO = {						//Many properties are unused , delete unneccessary						objectCanvasLeftX : objectCanvasLeftX , 						objectCanvasTopY : objectCanvasTopY,						leftWithoutRotate : o.oCoords.tl.x, 						topWithoutRotate : o.oCoords.tl.y, 						widthWithoutRotate : parseFloat(o.getWidth()*scale) , //Imp						heightWithoutRotate :parseFloat( o.getHeight()*scale) ,						widthWithoutRotateUnScaled : o.width ,						heightWithoutRotateUnScaled : o.height ,						src: o.getSrc(),						id : o.object_id ,						angle : angle ,//gives the angle in radians							angleModified : angleModified ,						groupWidth : currGroup.width ,						groupHeight : currGroup.height ,						scale : scale					};										ddata.push( myO );										item_ids.push(myO.id);					// In case of JOIN remove the objects where as in Export keep objects  on the canvas					if(typeof(itemTitle) === "undefined")  					{						c.remove(o);					}				} );				c.discardActiveGroup(currGroup);				}						// HACK for exporting single i . e . already joined object the canvas element is not needed						var canvasElement = document.createElement('canvas');									var cw = ((currGroup.type == "group") ? ((parseInt(currGroup.width/scale))) : ( parseInt(currGroup.width) )),				ch = ((currGroup.type == "group") ? ((parseInt(currGroup.height/scale))) : (parseInt(currGroup.height) )); 							canvasElement.width = cw;			canvasElement.height = ch;						var canDimension = {width:cw , height:ch };			var context = canvasElement.getContext('2d');				this.drawCustomImage( ddata, 0, context, canDimension ,  function(isErr) {				try				{					var groupToAdd = (( currGroup.type == "group" ) ? (canvasElement.toDataURL() ) : (currGroup.getSrc()) ) ;										var itemSizeInCm = Math.round(parseFloat(cw/CHelp.cmToPxFactor)*1000)/1000 ; 	// Round to 3 decimals										if(itemTitle) // Export the item					{							if(currGroup.type == "group")							c.discardActiveGroup(currGroup).renderAll();						else 						{							//c.discardActiveObject(currGroup).renderAll();						}												var exportJSONobj = { 							title: itemTitle,							size : itemSizeInCm , 							data_uri : groupToAdd ,														items : JSON.stringify(item_ids)						};												CHtml.blockScreen('Exporting object as '+exportJSONobj.title);						CHelp._m_under_process = true ; 												$.post("/export_item/", exportJSONobj, function(response) {														if(response)							{								$.blockUI({ message: "<div class='validate'><div style='float:left;width:15%'><img src='/static/img/check.png' align=center/></div><div style='width:70%;float:left; padding-top: 2px;'>"+exportJSONobj.title+" is exported successfully</div>" }); 													setTimeout(function(){CHtml.unBlockScreen();} , 3000) ; // Show Saved successfully for 3 seconds							}												},'json' );												 						return(groupToAdd);					}					else //Add the combined object as a group on the canvas					{						fabric.Image.fromURL(groupToAdd, function(img) { 											var groupImg = img.set({ left:groupx, top:groupy, angle: 0 ,						lockScalingX:true , lockScalingY:true ,hasRotatingPoint:true ,						hasControls: true, hasEndPoints: false , 						selectable : ((CPan._isActive)?(false):(true)),						isJoinedObj : true //Flag to know the object is already joined from group of objects						}).scale(scale) ;												c.add(groupImg).renderAll(); 						c.setActiveObject(groupImg);						c.renderAll();						//window.open(groupToAdd); //Final group to add on the canvas						CState.saveState(c);												} ); 												return(groupToAdd);					}									}				catch(e)				{					console.log("Exception "+e);				}			} );			}		else		{			CHtml.showErrorNotification('Please select two or more objects');		}	},		drawCustomImage : function ( ddata, dix, dcx, canDimension ,  cb )	{		if( dix < ddata.length )		{			if( ddata[dix].angleModified) //image is rotated			{				var imgObj = new Image();									imgObj.onload = function() {									var canvasElement = document.createElement('canvas');  //1.Create temp can as group area					var context = canvasElement.getContext('2d');										canvasElement.width = canDimension.width ; 					canvasElement.height = canDimension.height ; 										var leftWithoutRotate =  ddata[dix].leftWithoutRotate;//2.Get tl of img without rotation					var topWithoutRotate = ddata[dix].topWithoutRotate;										var widthWithoutRotate =  ddata[dix].widthWithoutRotate ;//3.get image w & img h without rotation					var heightWithoutRotate = ddata[dix].heightWithoutRotate ;										var objectXCoord = ddata[dix].objectCanvasLeftX ;  //4.ctx.traslate(left+w/2 , top+h/2)					var objectYCoord = ddata[dix].objectCanvasTopY ;															context.translate( objectXCoord , objectYCoord );										context.rotate( ddata[dix].angle ); //step 5 rorate by degrees										context.translate( -objectXCoord , -objectYCoord ); //step 6 context.translate using -1 * (l + width/2)					 										 //7.draw img at tl got in step 2 without rotation					context.drawImage( imgObj, objectXCoord, objectYCoord);										//context.fillRect(objectXCoord , objectYCoord , 10 , 10 ); //Draw temp rect										//step 8 draw temp canvas ontop the canvas which will form the new object at cords 0,0 						dcx.drawImage( canvasElement,0, 0 );										//window.open( canvasElement.toDataURL()) ;										CFab.drawCustomImage( ddata, ++dix, dcx, canDimension , cb );				};								imgObj.onerror = function() {					 cb(false);				} 								imgObj.src = ddata[dix].src;				/* var widthWithoutRotateUnScaled = ddata[dix].widthWithoutRotateUnScaled;					var heightWithoutRotateUnScaled = 	ddata[dix].heightWithoutRotateUnScaled;				*/				// fresh steps				// calculate mid point of where image will be; objectCanvasLeftX + (w/2)			}			else			{						var imgObj = new Image();							imgObj.onload = function() {					dcx.drawImage( imgObj, ddata[dix].objectCanvasLeftX, ddata[dix].objectCanvasTopY );									CFab.drawCustomImage( ddata, ++dix, dcx, canDimension , cb );				};							imgObj.onerror = function() {					 cb(false);				}							imgObj.src = ddata[dix].src;			}		}		else			cb(true);	},		setScaleIndicator: function(scale)	{		var dsf = 60, cmpxconv = CHelp.cmToPxFactor ; // 1 CM = 37.7 PIXELS		var dispsf = (parseFloat(dsf) / parseFloat(scale)); // = 60px scalled as per scale factor				var cm_val = (dispsf / cmpxconv); // get the scalled dispplay width in cm				CFab._scale_single_pixel_in_cm = (cm_val / dsf); // = 1px will equal so many cm				var rounded = Math.round( cm_val * 10 ) / 10;		$(".cm").text(''+rounded+'cm'); // Dispay CM value besides SCALE BAR		CFab._m_cm_scale = rounded ;	},		bringToFront : function ( c )	{		var obj = c.getActiveObject();		if( obj )		{			c.bringForward(obj) ;			c.renderAll();		}		else			CHtml.showErrorNotification('Please select an object to bring to front');			},		sendToBack : function ( c )	{		var obj = c.getActiveObject();		if(obj)		{			c.sendBackwards(obj) ;			c.renderAll();		}		else			CHtml.showErrorNotification('Please select an object to send to back');		},		deleteObjects : function (c)	{		if(c.getActiveGroup())		{			c.getActiveGroup().forEachObject(function(o){ c.remove(o) });			c.discardActiveGroup().renderAll();		} 		else if(c.getActiveObject())		{			c.remove(c.getActiveObject());		}		else			CHtml.showErrorNotification('Please select object to delete');		},		keepMeInView: function(c, v)	{				var canvas_width = $('#c').width() , canvas_height = $('#c').height() , dsafety = 30, bDone = false;						var t = v.getBoundingRect().top,			l = v.getBoundingRect().left,			w = v.getBoundingRect().width,			h = v.getBoundingRect().height;					var objProp = { t: t , l:l , w:w , h:h , canvas_width:canvas_width , canvas_height:canvas_height};  // Debug info				//console.dir(objProp);				if( ( (t + h) ) <= dsafety )  // Top 		{			v.set("top" , (dsafety - h) + (h/2) );			bDone = true;		}		if( ( ( l + w ) ) <= dsafety ) // left		{				v.set("left" , (dsafety - w) + (w/2) );			bDone = true;		}				if( t >= (canvas_height) -  dsafety) // bottom 		{			v.set("top" , ( canvas_height - dsafety ) + (h/2) ); 			bDone = true;		}		if( l >= ((canvas_width) -  dsafety) ) // right		{			v.set("left" , ( canvas_width - dsafety ) + (w/2) ); 			bDone = true;		}		if(bDone)		{					v.setCoords();			c.renderAll();		}	},		scaleWithKeyboardShortcut:function(isZoomIn)	{		var newScaleValue =  (isZoomIn) ? ( parseFloat(parseFloat( CHelp._m_current_scale )+ parseFloat( CHelp._SCALE_RANGE.step)).toFixed(2) ):( parseFloat( parseFloat(CHelp._m_current_scale) - parseFloat(CHelp._SCALE_RANGE.step)).toFixed(2)) ;				if( newScaleValue >= CHelp._SCALE_RANGE.start && newScaleValue <= CHelp._SCALE_RANGE.end )		{			CHelp._m_current_scale = newScaleValue;//Round to 2 decimal			$("#scale").val(CHelp._m_current_scale);			CFab.adjustScale(CHelp._m_current_scale);			}				if( newScaleValue < CHelp._SCALE_RANGE.start )			CHtml.showErrorNotification('Minimum scale is reached') ;		else if ( newScaleValue > CHelp._SCALE_RANGE.end )			CHtml.showErrorNotification('Maximum scale is reached');					}}